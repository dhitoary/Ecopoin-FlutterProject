rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTION ---
    // Cek apakah user yang request memiliki role 'admin' atau 'petugas'
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.role == "admin" || request.auth.token.role == "petugas");
    }

    // Cek apakah user sudah login
    function isAuthenticated() {
      return request.auth != null;
    }

    // --- 1. REWARDS COLLECTION ---
    match /rewards/{document=**} {
      // Semua user login bisa lihat katalog hadiah
      allow read: if isAuthenticated();
      // Hanya admin/petugas bisa kelola (tambah/edit/hapus)
      allow write: if isAdmin();
    }

    // --- 2. USERS COLLECTION ---
    match /users/{userId} {
      // User bisa baca/tulis datanya sendiri
      allow read, update: if isAuthenticated() && request.auth.uid == userId;
      // Admin bisa baca & update semua user (misal: banned user)
      allow read, update: if isAdmin();
      // Allow create saat register
      allow create: if isAuthenticated();
    }

    // --- 3. VERIFICATION REQUESTS (SETORAN) ---
    match /verificationRequests/{document=**} {
      // User bisa buat request setoran
      allow create: if isAuthenticated();
      // User bisa lihat request miliknya sendiri
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Admin bisa update status (approve/reject) & hapus
      allow update, delete: if isAdmin();
    }

    // --- 4. USER VOUCHERS (RIWAYAT PENUKARAN - BARU) ---
    match /userVouchers/{document=**} {
      // User bisa lihat vouchernya sendiri
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // User bisa buat voucher baru (saat redeem poin) - pastikan userId di data == uid login
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Admin bisa lihat semua riwayat penukaran
      allow read: if isAdmin();
    }

    // --- 5. NOTIFICATIONS (PEMBERITAHUAN - BARU) ---
    match /notifications/{document=**} {
      // User bisa lihat notifikasi miliknya
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // User bisa update status 'read' notifikasinya sendiri
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admin (sistem) bisa buat notifikasi untuk user
      allow create: if isAdmin();
      // Admin bisa hapus/kelola notifikasi jika perlu
      allow write: if isAdmin();
    }

    // --- 6. ARTICLES (EDUKASI) ---
    match /articles/{document=**} {
      // Public read (bahkan tanpa login pun boleh, atau batasi isAuthenticated())
      allow read: if true;
      // Hanya admin yang bisa nulis artikel
      allow write: if isAdmin();
    }
    
    // --- 7. TRANSACTIONS (LOG SETORAN/REDEEM - JIKA ADA) ---
    match /transactions/{document=**} {
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read: if isAdmin();
    }
  }
}